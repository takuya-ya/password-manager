#!/bin/bash

# 未入力項目と文字数超過を確認し、該当するエラーメッセージを配列に追加
validation_user_inputs()
{
    local -A input_errors=(
        ['service_name']='\033[31mサービス名が入力されていません\033[0m'
        ['user_name']='\033[31mユーザー名が入力されていません\033[0m'
        ['password']='\033[31mパスワードが入力されていません\033[0m'
    )
    local -A length_errors=(
        ['service_name']='\033[31mサービス名は50文字以内で入力してください\033[0m'
        ['user_name']='\033[31mユーザー名は50文字以内で入力してください\033[0m'
        ['password']='\033[31mパスワードは50文字以内で入力してください\033[0m'
    )
    MAX_CAHRACTERS=50
    # user_inputsのインデントをindentとしてループし、ユーザー入力情報とエラー文を紐づける
    for indent in "${!user_inputs[@]}"; do
        if [ -z "${user_inputs[$indent]}" ]; then
            error_messages+=("${input_errors[$indent]}")
        elif [ "${#user_inputs[$indent]}" -ge "$MAX_CAHRACTERS" ]; then
            error_messages+=("${length_errors[$indent]}")
        fi
    done
}

save_user_inputs()
{
    (
        echo "${user_inputs['service_name']}":"${user_inputs['user_name']}":"${user_inputs['password']}" >> user_inputs
    ) 2>> error.txt

    if [ $? -ne 0 ]; then
        echo -e  '\033[31m入力内容の保存に失敗しました\033[0m'
        return
    fi

    echo 'パスワードの追加は成功しました。'
}

add_password()
{
    local -A user_inputs=(['service_name']='' ['user_name']='' ['password']='')
    local -a error_messages=()

    read -p 'サービス名を入力して下さい：' user_inputs['service_name']
    read -p 'ユーザー名を入力して下さい：' user_inputs['user_name']
    read -p 'パスワードを入力して下さい：' user_inputs['password']
    echo ''

    validation_user_inputs

    if [ -z "$error_messages" ]; then
        # 入力が正常な場合、入力を保存
        save_user_inputs
    else
        # 入力に異常がある場合、配列のエラー文を出力
        for error in "${error_messages[@]}"; do
            echo -e $error
        done
    fi
}

get_password()
{
    read -p 'サービス名を入力してください:' service_name
    grep ^"$service_name" user_inputs | awk -F ':' '{print "\nサービス名:"$1 "\nユーザー名:"$2 "\nパスワード:"$3}'
    # TODO:サービス名が登録されていなった場合、エラーを出力
}

echo 'パスワードマネージャーへようこそ！'
while true; do
    read -p '次の選択肢から入力してください(Add Password/Get Password/Exit):' menu
    case $menu in
    # TODO: 手動テスト簡略化の為、一時的にパターンを省略
        'a')
            add_password
            ;;
        'g')
            get_password
            ;;
        'Exit')
            echo -e "Thank you\033[31m!\033[0m"
            exit
            ;;
        *)
            echo ''
            echo -e '\033[31m選択肢から入力してください\033[0m'
            ;;
    esac
done
